"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[898],{3905:(e,t,r)=>{r.d(t,{Zo:()=>u,kt:()=>v});var n=r(7294);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){a(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,a=function(e,t){if(null==e)return{};var r,n,a={},l=Object.keys(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||(a[r]=e[r]);return a}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)r=l[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(a[r]=e[r])}return a}var o=n.createContext({}),d=function(e){var t=n.useContext(o),r=t;return e&&(r="function"==typeof e?e(t):c(c({},t),e)),r},u=function(e){var t=d(e.components);return n.createElement(o.Provider,{value:t},e.children)},s="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,a=e.mdxType,l=e.originalType,o=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),s=d(r),m=a,v=s["".concat(o,".").concat(m)]||s[m]||p[m]||l;return r?n.createElement(v,c(c({ref:t},u),{},{components:r})):n.createElement(v,c({ref:t},u))}));function v(e,t){var r=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var l=r.length,c=new Array(l);c[0]=m;var i={};for(var o in t)hasOwnProperty.call(t,o)&&(i[o]=t[o]);i.originalType=e,i[s]="string"==typeof e?e:a,c[1]=i;for(var d=2;d<l;d++)c[d]=r[d];return n.createElement.apply(null,c)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"},1890:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>o,contentTitle:()=>c,default:()=>s,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var n=r(7462),a=(r(7294),r(3905));const l={title:"\uc4f0\ub808\ub4dc \ub85c\uceec - ThreadLocal",sidebar_position:1},c="1. \ud544\ub4dc \ub3d9\uae30\ud654",i={unversionedId:"lecture/spring-advance/one",id:"lecture/spring-advance/one",title:"\uc4f0\ub808\ub4dc \ub85c\uceec - ThreadLocal",description:"---",source:"@site/docs/lecture/spring-advance/one.md",sourceDirName:"lecture/spring-advance",slug:"/lecture/spring-advance/one",permalink:"/docs/lecture/spring-advance/one",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/lecture/spring-advance/one.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"\uc4f0\ub808\ub4dc \ub85c\uceec - ThreadLocal",sidebar_position:1},sidebar:"tutorialSidebar",previous:{title:"JS \uc751\uc6a9",permalink:"/docs/lecture/react/two"},next:{title:"\ud15c\ud50c\ub9bf \uba54\uc11c\ub4dc \ud328\ud134",permalink:"/docs/lecture/spring-advance/two"}},o={},d=[{value:"\uc139\uc158 1 \ucf54\ub4dc",id:"\uc139\uc158-1-\ucf54\ub4dc",level:2},{value:"\ud574\uacb0\ucc45: Trace\uc6a9 \uc2f1\uae00\ud1a4 \uac1d\uccb4 \uc0dd\uc131",id:"\ud574\uacb0\ucc45-trace\uc6a9-\uc2f1\uae00\ud1a4-\uac1d\uccb4-\uc0dd\uc131",level:2},{value:"\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\ucc45: ThreadLocal",id:"\ub3d9\uc2dc\uc131-\ubb38\uc81c-\ud574\uacb0\ucc45-threadlocal",level:3}],u={toc:d};function s(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,n.Z)({},u,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"1-\ud544\ub4dc-\ub3d9\uae30\ud654"},"1. \ud544\ub4dc \ub3d9\uae30\ud654"),(0,a.kt)("hr",null),(0,a.kt)("h2",{id:"\uc139\uc158-1-\ucf54\ub4dc"},"\uc139\uc158 1 \ucf54\ub4dc"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'// Controller \ub2e8\n@GetMapping("/v2/request")\npublic String request(String itemId) {\n\n  TraceStatus status = null;\n  try {\n    status = trace.begin("OrderController.request()");\n    orderService.orderItem(status.getTraceId(), itemId);\n    trace.end(status);\n    return "ok";\n  } catch (Exception e) {\n    trace.exception(status, e);\n    throw e;//\uc608\uc678\ub97c \uaf2d \ub2e4\uc2dc \ub358\uc838\uc8fc\uc5b4\uc57c \ud55c\ub2e4.\n  }\n}\n\n\n// Service \ub2e8\npublic void orderItem(TraceId traceId, String itemId) {\n\n  TraceStatus status = null;\n  try {\n    status = trace.beginSync(traceId, "OrderService.orderItem()");\n    orderRepository.save(status.getTraceId(), itemId);\n    trace.end(status);\n  } catch (Exception e) {\n    trace.exception(status, e);\n    throw e;\n  }\n\n}\n\n// Repository \ub2e8\npublic void save(TraceId traceId, String itemId) {\n\n  TraceStatus status = null;\n  try {\n    status = trace.beginSync(traceId, "OrderRepository.save()");\n\n    //\uc800\uc7a5 \ub85c\uc9c1\n    if (itemId.equals("ex")) {\n      throw new IllegalStateException("\uc608\uc678 \ubc1c\uc0dd!");\n    }\n    sleep(1000);\n\n    trace.end(status);\n  } catch (Exception e) {\n    trace.exception(status, e);\n    throw e;\n  }\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\uc774\uc804 \ubc29\uc2dd\uc744 \ud655\uc778\ud574\ubcf4\uba74, Controller <-> Service <-> Repository\ub97c \uc624\uac00\uba70 TraceId\ub97c Parameter\ub85c \uc804\ub2ec\ud558\uc5ec \ud544\ub4dc\ub97c \ub3d9\uae30\ud654\ud588\ub2e4.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\ubb38\uc81c\uc810: \ubaa8\ub4e0 \uba54\uc11c\ub4dc Parameter\ub85c TraceId\ub97c \ubc1b\uc544\uc57c \ud568.")))),(0,a.kt)("h2",{id:"\ud574\uacb0\ucc45-trace\uc6a9-\uc2f1\uae00\ud1a4-\uac1d\uccb4-\uc0dd\uc131"},"\ud574\uacb0\ucc45: Trace\uc6a9 \uc2f1\uae00\ud1a4 \uac1d\uccb4 \uc0dd\uc131"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},'\n@Slf4j\npublic class FieldLogTrace implements LogTrace {\n\n    private static final String START_PREFIX = "--\x3e";\n    private static final String COMPLETE_PREFIX = "<--";\n    private static final String EX_PREFIX = "<X-";\n\n    private TraceId traceIdHolder; //traceId \ub3d9\uae30\ud654, \ub3d9\uc2dc\uc131 \uc774\uc288 \ubc1c\uc0dd\n\n    @Override\n    public TraceStatus begin(String message) {\n        ...\n    }\n\n    // \uac19\uc740 \uc694\uccad\uc5d0 \ub300\ud574 TraceId\ub97c \ub3d9\uae30\ud654\ud558\ub294 \uacfc\uc815 (depth +)\n    private void syncTraceId() {\n        if (traceIdHolder == null) {\n            traceIdHolder = new TraceId();\n        } else {\n            traceIdHolder = traceIdHolder.createNextId();\n        }\n    }\n    \n    // \uac19\uc740 \uc694\uccad\uc5d0 \ub300\ud574 TraceId\ub97c \ub3d9\uae30\ud654\ud558\ub294 \uacfc\uc815(depth -)\n    private void releaseTraceId() {\n        if (traceIdHolder.isFirstLevel()) {\n            traceIdHolder = null; //destroy\n        } else {\n            traceIdHolder = traceIdHolder.createPreviousId();\n        }\n    }\n\n    @Override\n    public void end(TraceStatus status) {\n        ...\n    }\n\n    @Override\n    public void exception(TraceStatus status, Exception e) {\n        ...\n    }\n\n    private void complete(TraceStatus status, Exception e) {\n        ...\n    }\n\n    private static String addSpace(String prefix, int level) {\n        ...\n    }\n\n}\n')),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\ub85c\uadf8 \ucd94\uc801\uc744 \uc704\ud55c \uac1d\uccb4\ub97c \uc0dd\uc131\ud558\uc5ec \ud574\ub2f9 \uac1d\uccb4\uc5d0\uc11c TraceId\ub97c \uac00\uc9c4\ub2e4.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\ud558\uc9c0\ub9cc FieldLogTrace\ub97c \uc0ac\uc6a9\ud558\uba74 \ub3d9\uc2dc\uc131 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud55c\ub2e4."),(0,a.kt)("li",{parentName:"ul"},"\ud574\ub2f9 \uac1d\uccb4\ub294 Scope\uac00 \uc2f1\uae00\ud1a4\uc778\ub370, \uc694\uccad\uc774 \ub3d9\uc2dc\uc5d0 \uc5ec\ub7ff\uc77c \ub54c \uac01 TraceId\ub97c \ubcf4\uad00\ud558\uc9c0 \ubabb\ud55c\ub2e4."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"\uc989, \ub3d9\uc2dc\uc131 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud55c\ub2e4.")),(0,a.kt)("li",{parentName:"ul"},"\ucc38\uace0: ",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\uc9c0\uc5ed \ubcc0\uc218\ub294 \uba54\uc11c\ub4dc\uac00 \uc2e4\ud589\ub420 \ub584 \uac01\uae30 \ub2e4\ub978 \uba54\ubaa8\ub9ac\ub97c \ud560\ub2f9 \ubc1b\uc544 \ub3d9\uc2dc\uc131 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ud558\uc9c0 \uc54a\ub294\ub2e4."),(0,a.kt)("li",{parentName:"ul"},"\uc77d\uae30 \uc791\uc5c5\ub9cc \ud560 \uacbd\uc6b0 \ubc1c\uc0dd\ud558\uc9c0 \uc54a\uc74c.")))))),(0,a.kt)("h3",{id:"\ub3d9\uc2dc\uc131-\ubb38\uc81c-\ud574\uacb0\ucc45-threadlocal"},"\ub3d9\uc2dc\uc131 \ubb38\uc81c \ud574\uacb0\ucc45: ThreadLocal"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"\uad00\ub828 \uae00: ",(0,a.kt)("a",{parentName:"li",href:"https://dev.gmarket.com/62"},"https://dev.gmarket.com/62")),(0,a.kt)("li",{parentName:"ul"},"\uc4f0\ub808\ub4dc \ubcc4\ub85c \uc0dd\uc131\ub418\ub294 \ubcf4\uad00\uc18c (Thread \uc815\ubcf4\ub97c Key\uac12\uc73c\ub85c \ud558\uc5ec \uac12\uc744 \uc800\uc7a5\ud558\ub294 Map \uad6c\uc870)")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-java"},"private ThreadLocal<TraceId> traceIdHolder = new ThreadLocal<>();\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"FieldLogTrace\uac1d\uccb4\uc5d0\uc11c \ubb38\uc81c\uac00 \ub41c \ud544\ub4dc\ub97c ThreadLocal\ub85c \ub450\uace0"),(0,a.kt)("li",{parentName:"ul"},"get, set \uba54\uc11c\ub4dc\ub97c \ud65c\uc6a9\ud574 TraceId\ub97c \ub3d9\uae30\ud654\ud558\uba74 \ub3d9\uc2dc\uc131 \ubb38\uc81c\uac00 \ubc1c\uc0dd\ub418\uc9c0 \uc54a\uc74c."),(0,a.kt)("li",{parentName:"ul"},"\uc8fc\uc758 \uc0ac\ud56d",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"\uc694\uccad\uc774 \ub05d\ub0a0 \ub54c \uac12\uc744 \uaf2d remove \ud574\uc904 \uac83"),(0,a.kt)("li",{parentName:"ul"},"ThreadPool \ud658\uacbd\uc5d0\uc11c Thread\uac00 \uc81c\uac70\ub418\uc9c0 \uc54a\uae30\uc5d0, ThreadLocal\uc5d0\ub3c4 \uac12\uc774 \ub0a8\uc544\uc788\uac8c \ub41c\ub2e4."),(0,a.kt)("li",{parentName:"ul"},"Web \ud658\uacbd\uc5d0\uc11c \ub2e4\ub978 \uc720\uc800\uc758 \uc815\ubcf4\ub97c \uc81c\uacf5\ud574\uc904 \uc218\ub3c4..")))))}s.isMDXComponent=!0}}]);